#!/usr/bin/env ruby

require 'set'
require 'fileutils'
require 'mechanize'

def iloveck101(url)
  page_uri = URI.parse(url)
  if page_uri.hostname.nil? or not page_uri.hostname.end_with?('ck101.com')
    STDERR.print "Unrecognizeed URL: #{url}\n"
    return
  end

  case page_uri.path
  when %r{thread-(\d+)-.+\.html}
    thread_id = $1
  else
    STDERR.print "Unrecognizeed URL: #{url}\n"
    return
  end

  agent = Mechanize.new

  page = agent.get(page_uri)

  title = page.title.split(' - ')[0].gsub('/', '').strip

  puts "Parsing #{title}"

  image_url_set = Set.new(
    page.search('article img[file]')
      .map { |image_tag| image_tag['file'] }
      .find_all { |image_url| image_url.index('.thumb.').nil?}
  )

  target_folder_path = File.expand_path("~/Pictures/iloveck101/#{thread_id} - #{title}")
  if not Dir.exists?(target_folder_path)
    FileUtils.mkdir_p(target_folder_path)
  end

  puts "Found #{image_url_set.length} images."

  image_url_set.each { |image_url|
    puts "Downloading #{image_url}"

    image = agent.get(image_url)

    filename = File.expand_path(File.basename(image.uri.path), target_folder_path)
    image.save(filename)
  }

  puts 'Done!'
end

if __FILE__ == $0
  if ARGV.length >= 1
    iloveck101(ARGV[0])
  else
    STDERR.print "Usage: #{File.basename($0)} URL\n"
  end
end